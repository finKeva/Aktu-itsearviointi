<!DOCTYPE html>
<html lang="fi">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <title>Aktiivisen tuen toimintatavan itsearviointi</title>
</head>

<body>

<div class="container theme-showcase" role="main">

  <div id="logo-holder">
    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   width="100%" viewBox="0 0 810.925 152.47" enable-background="new 0 0 810.925 152.47"
	 xml:space="preserve">
      <g>
      	<path fill="#8DC63F" d="M0,152.47V0h466.456c0,84.207-72.566,152.47-156.773,152.47h4.303H0z"/>
      	<path fill="#FFFFFF" d="M183.255,97.439V72.392c0,0,0-5.756,5.758-5.756h39.509v5.222h-38.163c-1.881,0-1.881,1.881-1.881,1.881
      		v8.567h28.159v5.015h-28.159v8.773c0,0,0,1.88,1.881,1.88h38.163v5.225h-39.509C183.255,103.198,183.255,97.439,183.255,97.439
      		 M279.383,85.147c5.67-8.747,5.873-17.436,5.891-18.512h-5.222c-0.001,0.737-0.276,8.369-5.045,15.665
      		c-4.688,7.105-13.435,14.623-31.514,15.863V66.636h-5.224v36.708l2.693-0.083C262.178,102.662,273.692,93.999,279.383,85.147
      		 M331.859,73.738c0,0,0-1.881-1.88-1.881H298.92c-1.881,0-1.881,1.881-1.881,1.881v11.179h34.82V73.738z M331.859,103.198V89.931
      		h-34.82v13.268h-5.223V72.392c0,0,0-5.756,5.758-5.756h33.752c5.757,0,5.757,5.756,5.757,5.756v30.807H331.859z M167.852,72.019
      		c3.148-4.857,4.606-9.69,5.287-13.219h-5.337c-0.66,2.924-1.92,6.689-4.328,10.369c-4.688,7.108-13.434,14.625-31.515,15.864V58.8
      		h-5.223v44.398h5.223V90.012c10.696-0.648,18.771-3.421,24.795-7.181l14.261,20.367h6.286l-16.592-23.201
      		C163.731,77.514,166.078,74.775,167.852,72.019 M78.64,64.851c-6.185,0-11.199-4.96-11.199-11.08
      		c0-6.119,5.015-11.079,11.199-11.079c6.187,0,11.201,4.96,11.201,11.079C89.841,59.891,84.826,64.851,78.64,64.851 M89.57,86.766
      		c0,6.196-5.023,11.218-11.22,11.218c-6.194,0-11.218-5.021-11.218-11.218c0-6.195,5.024-11.219,11.218-11.219
      		C84.547,75.547,89.57,80.57,89.57,86.766 M104.102,86.957c0-8.344-4.605-13.473-6.427-15.296c-3.619-3.617-8.734-5.801-8.734-5.75
      		c0,0.786-3.071,7.225-10.335,7.225c-8.025,0-10.503-7.288-10.503-7.288s-3.689,0.685-9.1,6.097
      		c-5.481,5.48-6.307,11.35-6.307,14.893c0,8.924,5.614,14.416,6.996,15.797c1.38,1.383,8.105,7.145,18.708,7.145
      		c11.358,0,17.892-6.186,19.274-7.568C99.054,100.831,104.102,95.83,104.102,86.957"/>
      	<path fill="#8DC63F" d="M773.618,109.777h6.344V65.382h-6.344V109.777z M754.133,71.724h-37.717c-2.281,0-2.281,2.283-2.281,2.283
      		v13.574h39.998c2.283,0,2.283-2.284,2.283-2.284v-11.29C756.417,74.007,756.417,71.724,754.133,71.724 M755.768,93.67h-4.771
      		l11.277,16.107h-7.408L743.586,93.67h-29.451v16.107h-6.344V72.373c0,0,0-6.991,6.992-6.991h40.984c6.99,0,6.99,6.991,6.99,6.991
      		V86.81l-0.002,0.005C762.713,87.749,762.208,93.67,755.768,93.67 M691.086,74.007c0,0,0-2.283-2.281-2.283h-37.717
      		c-2.283,0-2.283,2.283-2.283,2.283v13.574h42.281V74.007z M691.086,109.777V93.67h-42.281v16.107h-6.342V72.373
      		c0,0,0-6.991,6.99-6.991h40.984c6.992,0,6.992,6.991,6.992,6.991v37.404H691.086z M625.122,87.581h-42.283V74.007
      		c0,0,0-2.283,2.287-2.283h37.713c2.283,0,2.283,2.283,2.283,2.283V87.581z M631.463,109.777V72.373c0,0,0-6.991-6.992-6.991
      		h-40.982c-6.992,0-6.992,6.991-6.992,6.991v37.404h6.342V93.67h42.283v16.107H631.463z M510.852,65.382v44.396h6.342V98.591
      		c12.986-0.787,22.795-4.153,30.109-8.72l13.941,19.906h7.559l-16.699-23.347c3.672-3.017,6.52-6.341,8.674-9.69
      		c2.566-3.96,4.193-7.895,5.246-11.358h-6.672c-0.895,2.51-2.139,5.22-3.891,7.898c-5.691,8.631-16.313,17.759-38.268,19.265V65.382
      		H510.852z"/>
      </g>
    </svg>
  </div>

  <div class="page-header">
   <h1>Aktiivisen tuen toimintatavan itsearviointi</h1>
  </div>
  
  <div id="page-info">
    <p>Kullakin organisaatiolla on oma toimintatapansa johtaa työhyvinvointia ja työkykyä. Organisaatiot kutsuvat omia toimintatapojaan tai mallejaan eri nimillä. Keva käyttää nimitystä Aktiivisen tuen toimintatapa. Siihen sisältyy varhainen tuki, tehostettu tuki ja paluun tuki sekä työterveysyhteistyö.</p>
    <p>
      Arvioi seuraavia väittämiä. Vastausvaihtoehdot ovat:  
      <ul>
        <li>0 = asia ei toteudu</li>
        <li>1 = asia toteutuu osittain</li>
        <li>2 = asia toteutuu kattavasti</li>
      </ul>
    </p>
  </div>

  <div id="questionnaire">Ladataan...</div>

  <button type="button" class="btn btn-success" id="katso-tuloksia">
    <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Katso tuloksia
  </button>

  <div class="btn-toolbar" role="toolbar" id="tulokset-button-toolbar">
    <button type="button" class="btn btn-info" id="muokkaa-vastauksia">
      <span class="glyphicon glyphicon-random" aria-hidden="true"></span> Muokkaa vastauksia
    </button>
    <button type="button" class="btn btn-default" id="tulostaa-tulokset">
      <span class="glyphicon glyphicon-print" aria-hidden="true"></span> Tulosta / Tallenna pdf:ksi
    </button>
    <button type="button" class="btn btn-default" id="laheta-asiantuntijalle">
      <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Lähetä asiantuntijalle
    </button>
    <button type="button" class="btn btn-default" id="tallenna-tulokset-palvelimelle">
      <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Tallenna Kevan palvelimelle
    </button>
  </div>
  <div id="results">Ladataan...</div>
  
  
  
  <div id="myModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Tietojen tallennus Kevan palvelimelle</h4>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="exampleInputEmail1">Organisaationne koko</label>
              <input type="email" class="form-control" id="exampleInputEmail1" placeholder="Henkilöstömäärä">
            </div>
            <p>Mitä työnantajatyyppiä organisaationne edustaa</p>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsRadios1" value="option1"> Kunta-ala (kunnat, kaupungit, kuntayhtymät)
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsRadios2" value="option2"> Valtio
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsRadios2" value="option3"> Kirkko
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsRadios2" value="option4"> Osakeyhtiö
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsRadios2" value="option5"> Muu
              </label>
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  

  <p> </p>
 <!-- temp 6 -->
<p> </p>


<script type="text/javascript" charset="UTF-8">

var kysely =
[
  {
    "sectionHeader": "Perusrakenne",
    "sectionId": "perus",
    "sectionResponceScale": [0,1,2],
    "sectionResponceInfo": "0 ei toteudu, 1 toteutuu osittain, 2 toteutuu kattavasti",
    "sectionResponceScaleInfo": "Arvio (0-2)",
    "parts": [
      {
        "partDefinition": "<strong>Varhaisella tuella tarkoitetaan</strong> esimiehen ja työyksikön omia toimia työkykyongelmien ja työyhteisöongelmien ehkäisemiseksi.",
        "partHeader": "varhainen tuki",
        "partId": "vatu",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Varhainen tuki on käytössä",
            "questionResponce" : ""
          }, {
            "questionId" : 2,
            "questionText" : "Toimijoiden roolit ja vastuut on kuvattu varhaisen tuen vaiheessa"
          }, {
            "questionId" : 3,
            "questionText" : "Varhaisen tuen vaiheesta on tehty prosessikuvaus"
          }, {
            "questionId" : 4,
            "questionText" : "Esimiehet tunnistavat varhaisen tuen tarpeita jo ennen poissaolohälytyksiä (kun huoli herää)"
          } ]
      },{
        "partDefinition": "<strong>Tehostetulla tuella tarkoitetaan</strong> toimia, joilla työssä jatkamista tuetaan, kun työntekijän työkyky on jo heikentynyt tai kun työyhteisössä on jo ongelmia. Tehostettuun tukeen siirrytään kun esimiehen omat toimet eivät enää riitä, vaan hän tarvitsee yhteistyökumppaneita.",
        "partHeader": "tehostettu tuki",
        "partId": "tetu",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Tehostettu tuki on käytössä"
          }, {
            "questionId" : 2,
            "questionText" : "Toimijoiden roolit ja vastuut on kuvattu tehostetun tuen vaiheessa"
          }, {
            "questionId" : 3,
            "questionText" : "Tehostetun tuen vaiheesta on tehty prosessikuvaus"
          }, {
            "questionId" : 4,
            "questionText" : "Esimiehet tunnistavat tehostetun tuen vaiheen vaihtoehtoja (esim. ammatillinen kuntoutus, osasairauspäiväraha, osatyökyvyttömyyseläke, työyhteisösovittelu)"
          } ]
      },{
        "partDefinition": "<strong>Paluun tuella tarkoitetaan</strong> toimia, joilla tuetaan työntekijän palaamista työhön esimerkiksi pitkän sairauspoissaolon jälkeen.",
        "partHeader": "paluun tuki",
        "partId": "patu",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Paluun tuki on käytössä"
          }, {
            "questionId" : 2,
            "questionText" : "Toimijoiden roolit ja vastuut on kuvattu paluun tuen vaiheessa"
          }, {
            "questionId" : 3,
            "questionText" : "Paluun tuen vaiheesta on tehty prosessikuvaus"
          }, {
            "questionId" : 4,
            "questionText" : "Esimiehet sopivat yhteydenpidosta jo työntekijän sairauspoissaolon alkaessa"
          } ]
      } ]
  }, {
    "sectionHeader": "Toimintatavan selkeys",
    "sectionId": "toimintaselkeys",
    "sectionResponceScale": [0,1,2],
    "sectionResponceInfo": "0 ei toteudu, 1 toteutuu osittain, 2 toteutuu kattavasti",
    "sectionResponceScaleInfo": "Arvio (0-2)",
    "parts": [
      {
        "partDefinition": "",
        "partHeader": "",
        "partId": "ts",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Toimintatapa on esimiesnäkökulmasta selkeä ja ymmärrettävä"
          }, {
            "questionId" : 2,
            "questionText" : "Esimies tietää, keneen on yhteydessä eri tilanteissa"
          }, {
            "questionId" : 3,
            "questionText" : "Toimintatavassa on kuvattu prosessin kulku erilaisissa työkykyä heikentävissä tilanteissa"
          }, {
            "questionId" : 4,
            "questionText" : "Toimintatapa on helposti löydettävissä esim. intrasta"
          } ]
      } ]
  }, {
    "sectionHeader": "Toimintatavan juurruttaminen",
    "sectionId": "toimintajuurrutus",
    "sectionResponceScale": [0,1,2],
    "sectionResponceInfo": "0 ei toteudu, 1 toteutuu osittain, 2 toteutuu kattavasti",
    "sectionResponceScaleInfo": "Arvio (0-2)",
    "parts": [
      {
        "partDefinition": "",
        "partHeader": "",
        "partId": "tj",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Esimiehet käyttävät toimintatapaa aktiivisesti ja oikea-aikaisesti"
          }, {
            "questionId" : 2,
            "questionText" : "Henkilöstö ymmärtää toimintatavan merkityksen"
          }, {
            "questionId" : 3,
            "questionText" : "Henkilöstö käyttää toimintatapaa aktiivisesti"
          }, {
            "questionId" : 4,
            "questionText" : "Toimintatapa on osa uuden työntekijän ja esimiehen perehdytysohjelmaa"
          }, {
            "questionId" : 5,
            "questionText" : "Toimintatapaa päivitetään aina tarvittaessa"
          }, {
            "questionId" : 6,
            "questionText" : "Toimintatapaa päivitetään laaja-alaisessa yhteistyössä keskeisten toimijoiden kanssa"
          }, {
            "questionId" : 7,
            "questionText" : "Työterveyshuolto toimii aktiivisesti toimintatavan juurruttamisessa"
          } ]
      } ]
  }, {
    "sectionHeader": "Aktiivisen tuen toimintatavan johtaminen",
    "sectionId": "aktujohto",
    "sectionResponceScale": [0,1,2],
    "sectionResponceInfo": "0 ei toteudu, 1 toteutuu osittain, 2 toteutuu kattavasti",
    "sectionResponceScaleInfo": "Arvio (0-2)",
    "parts": [
      {
        "partDefinition": "",
        "partHeader": "",
        "partId": "aj",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Aktiivisen tuen toimivuudelle on asetettu selkeät muutostavoitteet (koskien esim. työilmapiirin parantamista, henkilöstön työhyvinvoinnin parantamista, sairauspoissaolojen vähentämistä, työkyvyttömyyseläkkeiden vähentämistä)"
          }, {
            "questionId" : 2,
            "questionText" : "Tavoitteiden toteutumista/ muutosta aikaisempaan tilanteeseen arvioidaan selkein mittarein"
          }, {
            "questionId" : 3,
            "questionText" : "Eri johtamisen tasoille on määritelty omat seurattavat mittarit (työyksikkötaso, toimialataso, organisaatiotaso)"
          }, {
            "questionId" : 4,
            "questionText" : "Seuranta- ja arviointivastuut on määritelty selkeästi (lähiesimiehet, toimialajohto)"
          }, {
            "questionId" : 5,
            "questionText" : "Henkilöstön tilaa ja henkilöstömuutoksia ennakoidaan säännöllisesti ja ryhdytään tarvittaviin toimenpiteisiin"
          }, {
            "questionId" : 6,
            "questionText" : "Aktiivien tuen toimintatavan kokonaisvastuu on määritetty jollekin taholle"
          }, {
            "questionId" : 7,
            "questionText" : "Työkyvyttömyyskustannusten seuranta on vastuutettu jollekin taholle ja tietoja analysoidaan säännöllisesti ja ryhdytään sovittuihin toimenpiteisiin"
          }, {
            "questionId" : 8,
            "questionText" : "Aktiivisen tuen seurantaan on sähköinen järjestelmä, joka edellyttää esimieheltä reagointia"
          }, {
            "questionId" : 9,
            "questionText" : "Osatyökykyisten sijoittuminen yli toimialarajojen on mahdollistettu"
          }, {
            "questionId" : 10,
            "questionText" : "Toimintatavassa on myös esitetty viimeisenä vaihtoehtona työsuhteen päättäminen, jos mitkään muut vaihtoehdot eivät tuo ratkaisua"
          }, {
            "questionId" : 11,
            "questionText" : "Organisaation taloudellisen ja toiminnallisten päätösten yhteydessä arvioidaan niiden henkilöstövaikutuksia"
          } ]
      } ]
  }, {
    "sectionHeader": "Työterveysyhteistyö aktiivisen tuen toimintatavassa",
    "sectionId": "tthcoop",
    "sectionResponceScale": [0,1,2,4],
    "sectionResponceInfo": "ei 0, osittain 1, huomioitu 2",
    "sectionResponceScaleInfo": "Arvio (0-2)",
    "parts": [
      {
        "partDefinition": "",
        "partHeader": "",
        "partId": "tj",
        "questions": [
          {
            "questionId" : 1,
            "questionText" : "Työterveyshuollon toimintasuunnitelman keskeiset tavoitteet ovat linjassa aktiivisen tuen toiminnalle asetettuihin tavoitteisiin"
          }, {
            "questionId" : 2,
            "questionText" : "Työterveyshuollon toiminnalle on asetettu selkeät mittarit"
          }, {
            "questionId" : 3,
            "questionText" : "Esimiehet osaavat käyttää työterveyshuollon palveluja aktiivisen tuen tilanteissa"
          }, {
            "questionId" : 4,
            "questionText" : "Työterveyshuolto osaa aktiivisesti tarjota Kevan ja Kelan tarjoamia tukimuotoja työkyvyn ollessa alentunut"
          }, {
            "questionId" : 5,
            "questionText" : "Työterveyshuolto tuntee Kevan tarjoamaa ammatillista kuntoutusta ja sen edellytyksiä"
          }, {
            "questionId" : 6,
            "questionText" : "Työterveyshuolto tunnistaa työkykyriskissä olevan työntekijän ja työyhteisön jossa on ongelmia ja ryhtyy aktiivisesti toimenpiteisiin"
          }, {
            "questionId" : 7,
            "questionText" : "30, 60, 90 – sääntö ja siihen liittyvät toimenpiteet toimivat sujuvasti"
          }, {
            "questionId" : 8,
            "questionText" : "Työterveyshuollon roolit ja vastuut aktiivisen tuen toimintatavassa on selkeästi määritelty"
          } ]
      } ]
  }
  ];

</script>

<script>
$pageInfoContainer = $("div#page-info");
$mainContainer = $("div#questionnaire");
$resultsContainer = $("div#results");
$resultsButton = $("button#katso-tuloksia");
$resultsToolbar = $("div#tulokset-button-toolbar");
$editButton = $("button#muokkaa-vastauksia");
$printButton = $("button#tulostaa-tulokset");
$saveResultsButton = $("button#tallenna-tulokset-palvelimelle");
$sendToExpert = $("button#laheta-asiantuntijalle");
//$fader = $("div#fader");

$printResults = function(){
  if($resultsContainer.css('display')=='block')
    window.print();
}

$sendEmail = function(){
  event.preventDefault();
  //alert("Got ya!");
  var email = 'kaari@keva.fi';
  var subject = 'Aktu-itsearviointi';
  var emailBody = 'Kirjoita oma viestisi, yhteystietosi ja mahdolliset kysymyksesi tämän viivan yläpuolelle\n-------------------------------------------------------------------------\n\n';
  
  $.each(kysely, function(i, section) {
    emailBody += section.sectionHeader+"\n\n";
    
    $.each(section.parts, function(j, part) {
      emailBody += part.partHeader+"\n";
      
      $.each(part.questions, function(k, question) {
        //qLength = question.questionText.length;
        //qTextToShow = question.questionText.substr(0,8)+"..."+question.questionText.substr(qLength-8,qLength-1);
        
        if(question.questionResponce == undefined)
          emailBody += question.questionId+": -\n";
        else
          emailBody += question.questionId+": "+question.questionResponce+"\n";
          //emailBody += question.questionResponce+"\t"+qTextToShow+"\n";

      });
      emailBody += "\n";
      
    });
    emailBody += "\n";
  });
  
  console.log(emailBody);
  console.log(emailBody.length);
  window.location = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(emailBody);
}

$sendResultsToServer = function(){
  //$fader.show();
  $activeResponces = $("div.btn-group.btn-group-xs .active");
  var resultsToSave = new Object;
  //console.log($activeResponces);
  $.each($activeResponces, function(i, button) {
    var par_ids = $(button).attr("id").split("-");
    //console.log(par_ids);
    resultsToSave[par_ids[0]+"-"+par_ids[1]+"-"+par_ids[2]] = par_ids[3].substr(1,2);
  });
  //console.log(resultsToSave);
  
  $.ajax({
    url: "http://url",
    type: 'POST',
    contentType:'application/json',
    data: JSON.stringify(resultsToSave),
    dataType:'json',
    success: function(data){
      //On ajax success do this
      window.resultsToSave = resultsToSave;
      console.log(JSON.stringify(resultsToSave));
      alert("Tiedot onnistuneesti tallennettu!");
      //$fader.hide();
    },
    error: function(xhr, ajaxOptions, thrownError) {
      //On error do this
      //$.mobile.loading('hide')
      console.log(xhr);
      console.log(ajaxOptions);
      console.log(thrownError);
      console.log(JSON.stringify(resultsToSave));
      //alert("Tietojen lähetys epäonnistui!");
      $("#myModal").modal('show');
      //$fader.hide();
      /*if (xhr.status == 200) {
        
        alert(ajaxOptions);
      }
      else {
        alert(xhr.status);
        alert(thrownError);
      }*/
    }
  });
  
}

$activateResponce = function() {
  var id = $( this ).attr('id');
  var par_ids = id.split("-");
  //console.log(par_ids);
  
  $.each(kysely, function(i, section) {
    if(section.sectionId == par_ids[0]){
      $.each(section.parts, function(j, part) {
        if(part.partId == par_ids[1]){
          $.each(part.questions, function(k, question) {
            if(question.questionId == par_ids[2].substr(1,2)){
              question.questionResponce = parseInt(par_ids[3].substr(1,2));
              return false;
            }
          });
          return false;
        }
      });
      return false;
    }
  });
  
  var len = id.length;
  var id_group = id.substr(0,len-1); 
  for(var i=0; i<=2; i++)
    $("#".concat(id_group,i)).removeClass("active");
  $( this ).addClass("active");
};

$createQuestionnaire = function() {
  $.each(kysely, function(i, section) {
    $sectionContainer = $("<div>", {id:section.sectionId + "-container"});
    $sectionContainer.append(
          $("<div>", {class:"page-header"}).append(
              $("<h2>",{text: section.sectionHeader})));
    
    $.each(section.parts, function(j, part) {
      $sectionContainer.append($("<p>",{html: part.partDefinition}));
      $qTable = $("<table>", {id:section.sectionId+"-"+part.partId, class: "table table-striped table-hover"});
      $qTable.append(
        $("<thead>")
          .append(
            $("<tr>")
              .append($("<th>", {class:"text-right", text:section.sectionResponceInfo}))
              .append($("<th>", {class:"text-center", text:section.sectionResponceScaleInfo}))));
      $qTable.append($("<tbody>"));
      
      $.each(part.questions, function(k, question) {
        $qRow = $("<tr>").append($("<td>",{text:question.questionText}))
        $qRow.append($("<td>", {class:"col-md-2 text-center",}));
        
        $buttonContainer = $("<div>", {id: section.sectionId+"-"+part.partId+"-k"+question.questionId+"-buttoncontainer", class: "btn-group btn-group-xs", role: "group"});
        $.each(section.sectionResponceScale, function(l, scale_num) {
          $qButton = $("<button>", {type:"button", class:"btn btn-default", id:section.sectionId+"-"+part.partId+"-k"+question.questionId+"-v"+scale_num, text: " "+scale_num+" "})
          if(question.questionResponce === l)
            $qButton.addClass("active");
          $qButton.click($activateResponce);
          $qButton.appendTo($buttonContainer);
        });
        
        $buttonContainer.appendTo($("td:last-child",$qRow));
        $qRow.appendTo($("tbody",$qTable));
      });
  
      $qTable.appendTo($sectionContainer);
    });
    
    $sectionContainer.appendTo($mainContainer);
  });

  $("div#questionnaire table tbody tr:last-child td").css("border-bottom", "1px solid #ddd");
}

$createResults = function() {
  $yhteenVetoContainer = $("<div>", {id:"results-yhteenveto-container"});
  $yhteenVetoContainer.appendTo($resultsContainer);
  $yhteenVetoContainer.append(
          $("<div>", {class:"page-header"}).append(
              $("<h2>",{text: "Yhteenveto"})));

  $resultsContainer.append(
          $("<div>", {class:"page-header"}).append(
              $("<h2>",{text: "Kiinnitä huomiota seuraaviin kohtiin"})));
  
  $.each(kysely, function(i, section) {
    $sectionContainer = $("<div>", {id:"results-"+section.sectionId + "-container"});
    $sectionContainer.append(
          $("<div>", {class:"page-header"}).append(
              $("<h3>",{text: section.sectionHeader})));
    
    $.each(section.parts, function(j, part) {
      //sectionResponceScale
      $sectionContainer.append($("<p>",{html: part.partHeader, class:"text-capitalize lead"}));
      $sectionContainer.append($("<div>",{id:"results-"+section.sectionId+"-"+part.partId+"-poimitutkysymykset", class:"col-md-offset-1"}));
      /*$sectionContainer.append($("<p>",{id:"results2-"+section.sectionId+"-"+part.partId+"-vastausmaarapisteet"}));
      $sectionContainer
        .append(
          $("<div>", {class:"progress", id:"progressbar2-"+section.sectionId+"-"+part.partId})
            .append(
              $("<div>",{id:"results2-"+section.sectionId+"-"+part.partId+"-pisteet", class:"progress-bar progress-bar-success"})
            )
        );*/
        
      $yhteenVetoContainer
        .append($("<div>", {class:"row"})
          .append($("<div>", {class:"col-md-4", html:section.sectionHeader+", "+part.partHeader})
            .append($("<br>"))
            .append($("<span>",{class:"small text-right",id:"results-"+section.sectionId+"-"+part.partId+"-vastausmaarapisteet"}).css("font-style","italic")))
          .append($("<div>", {class:"col-md-8"})
            .append($("<div>", {class:"progress", id:"progressbar-"+section.sectionId+"-"+part.partId})
              .append($("<div>",{id:"results-"+section.sectionId+"-"+part.partId+"-pisteet", class:"progress-bar progress-bar-success"}))))
        );


  
    });
    
    $sectionContainer.appendTo($resultsContainer);
  });

  $sectionContainer.append($("<p>", {html:"<br>Lisätietoa Aktiivisen tuen toimintatavasta ja sen kehittämisestä on Kevan sivuilla <a href='www.keva.fi/kaari'>www.keva.fi/kaari</a>.", class:"text-center"}))
}

$updateResults = function() {
  $.each(kysely, function(i, section) {
    
    $.each(section.parts, function(j, part) {
      var pisteet = 0;
      var vastausmaara = 0;
      var max_pisteet = Math.max.apply(Math, section.sectionResponceScale);
      var min_pisteet = undefined;
      $poimitutkysymykset = $("#results-"+section.sectionId+"-"+part.partId+"-poimitutkysymykset");
      $poimitutkysymykset
        .contents()
        .remove();
      
      $.each(part.questions, function(k, question) {
        if($.inArray(question.questionResponce, section.sectionResponceScale ) != -1){
          pisteet += question.questionResponce;
          vastausmaara++;
          if(question.questionResponce<min_pisteet || min_pisteet==undefined) min_pisteet = question.questionResponce;
        }
      });
      
      if(min_pisteet != undefined && min_pisteet != max_pisteet) {
        $poimitutkysymykset.append($("<p>",{html:"Vastasit "+min_pisteet+" seuraaviin väittämiin: "}));
        $.each(part.questions, function(k, question) {
          if(question.questionResponce == min_pisteet){
            $poimitutkysymykset.append($("<p>",{html:question.questionText,class:"small"}));
          }
        });
        
      } else {
        if(min_pisteet == undefined)
          $poimitutkysymykset.append($("<p>",{text:"Vastasit 0 väittämään"}));
        if(min_pisteet == max_pisteet)
          $poimitutkysymykset.append($("<p>",{text:"Vastasit kaikkiin väittämiin "+max_pisteet+", eli asiaa toteutuu kattavasti."}));
      }
      
      var maxpisteet = (part.questions.length*Math.max.apply(Math, section.sectionResponceScale))
      var pisteprosentti = Math.round(10000*pisteet/maxpisteet)/100;

      //$("#results2-"+section.sectionId+"-"+part.partId+"-vastausmaarapisteet").html("Vastasit "+vastausmaara+"/"+part.questions.length+" kysymykseen. Sait "+pisteet+"/"+maxpisteet+" pistettä.");
      $("#results-"+section.sectionId+"-"+part.partId+"-vastausmaarapisteet").html("vastaukset "+vastausmaara+"/"+part.questions.length);
      
      /*$("#results2-"+section.sectionId+"-"+part.partId+"-pisteet")
        .css("width", pisteprosentti+"%")
        .text("pisteesi");*/
      $("#results-"+section.sectionId+"-"+part.partId+"-pisteet")
        .css("width", pisteprosentti+"%")
        .text("pisteet "+pisteet+"/"+maxpisteet);
    });

  });

}


$switchQandR = function() {
  $updateResults();
  
  var timing = 700;
  $mainContainer.slideToggle(timing)
  $pageInfoContainer.slideToggle(timing);
  $resultsContainer.slideToggle(timing);
  $resultsButton.slideToggle(timing);
  $resultsToolbar.slideToggle(timing);
  $("html, body").animate({ scrollTop: 0 }, "slow");
}


</script>

<script>
$( document ).ready(function() {
  $mainContainer
      .contents()
      .remove();
  $createQuestionnaire();
  
  
  $mainContainer.show();
  $pageInfoContainer.show();
  $resultsContainer.hide();
  
  
  $resultsButton.click($switchQandR);
  $resultsButton.show();
  
  $editButton.click($switchQandR);
  $printButton.click($printResults);
  $saveResultsButton.click($sendResultsToServer);
  $sendToExpert.click($sendEmail);
  $resultsToolbar.hide();
  
  $resultsContainer
      .contents()
      .remove();
  $createResults();

});
</script>
<style>
  .btn-default.active, .btn-default:active{background-color:#ADE65F}
/*  @media print {
  .progress, .progress > .progress-bar-success {
      display: block !important;
      -webkit-print-color-adjust: exact !important;

    }
  }*/
@media print{       
  .progress{
    background-color: #F5F5F5 !important;
    -ms-filter: "progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr='#F5F5F5', endColorstr='#F5F5F5')" !important;
  }
  .progress-bar-success{
    display: block !important;
    background-color: #5cb85c !important;
    -ms-filter: "progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr='#5cb85c', endColorstr='#449d44 ')" !important;
  }

  .progress, .progress > .progress-bar {
    display: block !important;
    -webkit-print-color-adjust: exact !important;

    box-shadow: inset 0 0 !important;
    -webkit-box-shadow: inset 0 0 !important;
  }   
}
</style>
</body>
</html>

